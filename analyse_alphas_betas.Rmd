---
title: "Track T Cell Alphas and Beta Chains"
author: "Kari Stromhaug"
date: "03/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Description
Analysis of scRNA-seq data (with coupled antibody capture and TCR) from a melanoma patient (8 sampels in total) and TCR tracing

# Loading libraries and setting path
```{r loading libraries, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(knitr)
library(ggpubr)
library(cowplot)
library(Seurat)
library(openxlsx)
library(stringr)
library(Biostrings)
library(clustree)
library(pheatmap)

setwd("~/Dropbox (Partners HealthCare)/Melanoma p2 Analysis/")
```


# Loading the CD8 Objects for Analysis
```{r}
p2.tils.cd8 = readRDS('patient2/R_output/Seurat_Objects/TIL.CD8.seurat.Res04.20200228.rds')
p15.tils.cd8 = readRDS('patient15/R_output/Seurat_Objects/TIL.CD8.seurat.Res03.20200302.rds')
p2.cd8 = readRDS('patient2/R_output/Seurat_Objects/CD8.Res05.clustered.seurat.20200228.rds')
p15.cd8 = readRDS('patient15/R_output/Seurat_Objects/CD8.Res05.clustered.seurat.20200302.rds')
# p6.tils.cd8 = readRDS('patient6/R_output/Seurat_Objects')
# p11.tils.cd8 = readRDS('patient11/R_output/Seurat_Objects')

p2.tils.cd8@meta.data[is.na(p2.tils.cd8@meta.data$til.clonotype.family),]$til.clonotype.family <- 'None'
p15.tils.cd8@meta.data[is.na(p15.tils.cd8@meta.data$til.clonotype.family),]$til.clonotype.family <- 'None'

```

make cd8 pbmc objects
```{r}
Idents(p2.cd8)<-p2.cd8$sample
unique(Idents(p2.cd8))
p2.pbmc.cd8 = subset(p2.cd8, idents=c('PBMC_post_CD45pos_CD3pos', 'PBMC_pre_CD45pos_CD3pos', 'PBMC_relapse_CD45pos_CD3pos'))


Idents(p15.cd8)<-p15.cd8$sample
unique(Idents(p15.cd8))
p15.pbmc.cd8 = subset(p15.cd8, idents=c('PBMC_post_CD45pos_CD3pos.rds', 'PBMC_pre_CD45pos_CD3pos.rds'))

p2.pbmc.cd8@meta.data[is.na(p2.pbmc.cd8@meta.data$til.clonotype.family),]$til.clonotype.family <- 'None'
p15.pbmc.cd8@meta.data[is.na(p15.pbmc.cd8@meta.data$til.clonotype.family),]$til.clonotype.family <- 'None'

p15.pbmc.cd8 %>% NormalizeData(assay='RNA',normalization.method = 'LogNormalize', scale.factor = 1e6) %>% 
  FindVariableFeatures() %>% 
  ScaleData(features=rownames(p15.pbmc.cd8)) %>% 
  RunPCA(features=VariableFeatures(p15.pbmc.cd8), verbose=F) %>% 
  RunUMAP(reduction='pca', dims=1:50) %>%
  FindNeighbors(dims=1:50) %>%
  FindClusters(resolution=0.3)
p15.pbmc.cd8$clusters = p15.pbmc.cd8$seurat_clusters
Idents(p15.pbmc.cd8)<-p15.pbmc.cd8$clusters
DimPlot(p15.pbmc.cd8, label=TRUE)



saveRDS(p15.pbmc.cd8, 'patient15/R_output/Seurat_Objects/PBMC.CD8.seurat.Res03.20200326.rds')
p2.pbmc.cd8 = readRDS('patient2/R_output/Seurat_Objects/PBMC.CD8.seurat.Res04.20200228.rds')




```

#### first make heatmaps for the traced and not traced TCRs in each cluster
Cluster 
```{r}
DimPlot(p2.tils.cd8, label=TRUE)
p2.traced = p2.tils.cd8@meta.data %>% subset(TCR.Clone != 0 & !is.na(TCR.Clone))
DimPlot(p2.tils.cd8, cells.highlight = rownames(p2.traced))

par(mfrow=c(2,2))
for (i in 1:12) {
  fam = i
  fam.cells = rownames(p2.tils.cd8@meta.data[p2.tils.cd8@meta.data$til.clonotype.family==fam,])
  show(DimPlot(p2.tils.cd8, cells.highlight = fam.cells))
}

```


show top traced clonotypes in the pbmcs
```{r}
obj = p15.pbmc.cd8

DimPlot(obj, label=TRUE)
obj.traced = obj@meta.data %>% subset(TCR.Clone != 0 & !is.na(TCR.Clone))
DimPlot(obj, cells.highlight = rownames(obj.traced))
allfams = sort(unique(as.numeric(obj.traced$til.clonotype.family))); head(allfams); length(allfams)

par(mfrow=c(2,2))
for (i in 1:length(allfams)) {
  fam = allfams[i]
  show(fam)
  fam.cells = rownames(obj@meta.data[obj@meta.data$til.clonotype.family==fam,])
  show(DimPlot(obj, cells.highlight = fam.cells))
}

```




define a function for making the heatmaps
```{r, echo=FALSE}

PrepHeatmap <- function(markers, OBJ, topn) {

  annotations = OBJ@meta.data
  annotations = annotations[,c('clusters', 'til.clonotype.family')]
  annotations$til.clonotype.family <- as.character(annotations$til.clonotype.family)
  annotations = annotations[order(annotations$til.clonotype.family),]; dim(annotations)
  annotations = annotations[order(annotations$clusters),]
  rownames(annotations) = gsub('-', '.', rownames(annotations))
  
  
  n = data.frame(OBJ@assays$RNA@data); dim(n)
  n = n %>% subset(rownames(n) %in% topn$gene); dim(n)
  annotations = annotations %>% subset(rownames(annotations) %in% colnames(n)); dim(annotations)
  n = n[,rownames(annotations)]; dim(n)
  return(list(n, annotations))
}



PrepHeatmap2 <- function(markers, OBJ, topn) {

  annotations = OBJ@meta.data
  annotations = annotations[,c('clusters', 'is.clone')]
  annotations = annotations[order(annotations$is.clone),]; dim(annotations)
  annotations = annotations[order(annotations$clusters),]
  rownames(annotations) = gsub('-', '.', rownames(annotations))
  
  
  n = data.frame(OBJ@assays$RNA@data); dim(n)
  n = n %>% subset(rownames(n) %in% topn$gene); dim(n)
  annotations = annotations %>% subset(rownames(annotations) %in% colnames(n)); dim(annotations)
  n = n[,rownames(annotations)]; dim(n)
  return(list(n, annotations))
}


```


function for adding majority cluster
```{r, echo=FALSE}
AddMajorityCluster <- function(cluster.table, clonotype.matches) {
  show('ADDING MAJORITY CLUSTER')
  cols = c('cell.barcode', 'origin', 'clone', 'clonotype', 'all.counts', 'til.counts', 'Clonotype', 'CD4', 'CD8', 'TCR.clonotype.ID', 'TCR.clonotype.ID.revised')
  show('cluster.table then clonotype.matches')
  show(colnames(cluster.table))
  show(colnames(clonotype.matches))
  show(cluster.table$til.clonotype.family==clonotype.matches$til.clonotype.family)
  complete.table = merge(clonotype.matches, cluster.table, by='cell.barcode'); dim(complete.table)
  unique.clones = unique(complete.table$til.clonotype.family); cat('number of unique clones:', length(unique.clones), '\n')
  unique.clones = unique.clones[!is.na(unique.clones)]; cat('number that are not NA:', length(unique.clones), '\n')
  complete.table$majority.cluster <- NA
  cat('\n')
  show(colnames(complete.table))
  
  for (clones in unique.clones) {
    # show(clones)
    cat('dimensions of complete.table', dim(complete.table), '\n')
    cat('the clone is:', clones, '\n')
    cat('the clone is in the dataframe:', clones %in% complete.table$til.clonotype.family, '\n')
    clones.sub = complete.table %>% subset(til.clonotype.family==clones)
    cat('dimensions of subset:', dim(clones.sub), '\n')
    cluster.dist = table(clones.sub$clusters)
    num.clones = nrow(clones.sub)
    # cat('number of rows in subset:',num.clones, '\n')
    min.num = 0
    main.cluster = NA
    show(cluster.dist)
    # show(dim(cluster.dist))
    for (col in 0:(dim(cluster.dist)-1)) {
      col = as.character(col)
      cluster.dist[col]<- cluster.dist[col] / num.clones
      if (cluster.dist[col] > min.num) {
        min.num = cluster.dist[col]
        main.cluster = col
      }
    }
    cat('majority cluster:', main.cluster, '\n')
    # cat('done with clone', clones, '\n\n')
    # show(head(complete.table[,c('til.clonotype.family', 'majority.cluster', 'clusters')]))
    complete.table[which(complete.table$til.clonotype.family==clones), ]$majority.cluster <- main.cluster
  }
  show(head(complete.table))
  return(complete.table)
}

SplitChains <- function(clonotypes) {
  show('SPLITTING CHAINS')
  show(colnames(clonotypes))
  clonotypes = clonotypes %>% separate(alpha.1, ',', into=c('TRAV_1', 'TRAJ_1', 'CDR3A_1'))
  clonotypes = clonotypes %>% separate(alpha.2, ',', into=c('TRAV_2', 'TRAJ_2', 'CDR3A_2'))
  clonotypes = clonotypes %>% separate(beta.1, ',', into=c('TRBV_1', 'TRBD_1', 'TRBJ_1', 'CDR3B_1'))
  clonotypes = clonotypes %>% separate(beta.2, ',', into=c('TRBV_2', 'TRBD_2', 'TRBJ_2', 'CDR3B_2'))
  return(clonotypes)
}

GraphChains <- function(clonotypes, cluster.table) {
  show('GRAPHING CHAINS')
  cols = c('cell.barcode', 'origin', 'clone', 'clonotype', 'all.counts', 'til.counts', 'Clonotype', 'CD4', 'CD8', 'TCR.clonotype.ID', 'TCR.clonotype.ID.revised', 'til.clonotype.family', 'majority.cluster')
  tras = clonotypes[,c(cols, c('TRAV_1', 'TRAV_2'))]
  tras.small = tras[,c('cell.barcode', 'TCR.clonotype.ID.revised', 'majority.cluster', 'TRAV_1', 'TRAV_2')]; dim(tras.small)
  tras.small = merge(tras.small, cluster.table, by=c('cell.barcode')); dim(cluster.table); dim(tras.small)
  tras.small = tras.small %>% separate(TRAV_1, '-', into=c('TRAV_1.1', 'TRAV_1.2'))
  tras.small = tras.small %>% subset(TRAV_1.1!=0) %>% distinct(by=c(til.clonotype.family), .keep_all=TRUE); dim(tras.small); length(unique(tras.small$til.clonotype.family))
  # show(ggplot(tras.small) + geom_bar(aes(x=majority.cluster, fill=TRAV_1.1)))
  p15.tras.smaller = tras.small %>% subset(TRAV_1.1!=0)
  show(ggplot(p15.tras.smaller) + geom_bar(aes(x=TRAV_1.1, fill=majority.cluster)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + labs(y="clonotype family count"))
  
  travs = table(tras.small$TRAV_1.1)
  
  trbs = clonotypes[,c(cols, c('TRBV_1', 'TRBV_2'))]
  trbs.small = trbs[,c('cell.barcode', 'TCR.clonotype.ID.revised', 'majority.cluster', 'TRBV_1', 'TRBV_2')]; dim(trbs.small)
  trbs.small = merge(trbs.small, cluster.table, by=c('cell.barcode')); dim(cluster.table); dim(trbs.small)
  trbs.small = trbs.small %>% subset(TRBV_1!=0) %>% distinct(by=c(til.clonotype.family), .keep_all=TRUE); dim(trbs.small);
  # show(ggplot(trbs.small) + geom_bar(aes(x=majority.cluster, fill=TRBV_1)))
  trbs.small = trbs.small %>% separate(TRBV_1, '-', into=c('TRBV_1.1', 'TRBV_1.2'))
  # show(ggplot(trbs.small) + geom_bar(aes(x=majority.cluster, fill=TRBV_1.1)))
  show(ggplot(trbs.small) + geom_bar(aes(x=TRBV_1.1, fill=majority.cluster)) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + labs(y="clonotype family count"))
  
  p15.trbvs = table(trbs.small$TRBV_1.1)
}


MakeSpreadsheets <- function(clonotypes, seurat_object, folder) {
  show('MAKING SPREADSHEETS')
  # p15.clonotypes.split = SplitChains(p15.clonotypes)
  show(head(clonotypes[,c('til.clonotype.family', 'cell.barcode')], 30))
  
  cluster.table = seurat_object@meta.data[,c('til.clonotype.family', 'clusters')]
  cluster.table$cell.barcode = rownames(cluster.table)
  show(head(cluster.table[,c('til.clonotype.family', 'cell.barcode')], 30))
  cluster.table$til.clonotype.family<-NULL
  complete.table = AddMajorityCluster(cluster.table, clonotypes)
  show(colnames(complete.table))
  
  # unique(complete.table$majority.cluster)
  clonotypes.split = SplitChains(complete.table)
  show('PICKING UNIQUE CLONOTYPES')
  show(colnames(clonotypes.split))
  clonotypes.split.1 = clonotypes.split %>% subset(TRAV_1!=0 & TRBV_1!=0) %>% distinct(til.clonotype.family, .keep_all=TRUE)
  clonotypes.split.2 = clonotypes.split %>% subset(TRAV_1!=0 & !(til.clonotype.family %in% clonotypes.split.1$til.clonotype.family)) %>% distinct(til.clonotype.family, .keep_all=TRUE)
  clonotypes.split.unique = rbind(clonotypes.split.1, clonotypes.split.2)
  clonotypes.split.3 = clonotypes.split %>% subset(TRBV_1!=0 & !(til.clonotype.family %in% clonotypes.split.unique$til.clonotype.family)) %>% distinct(til.clonotype.family, .keep_all=TRUE)
  clonotype.split.unique = rbind(clonotypes.split.unique, clonotypes.split.3)
  dim(clonotype.split.unique)
  length(unique(clonotype.split.unique$til.clonotype.family))
  
  show('WRITING SPREADSHEETS')
  write.table(clonotypes.split, paste0(folder, '/R_output/majority_cluster_spreadsheet.txt'), sep='\t', row.names=F, quote=F)
  write.table(clonotypes.split.unique, paste0(folder, '/R_output/majority_cluster_family_spreadsheet.txt'), sep='\t', row.names=F, quote=F)
  
  return(list(clonotypes.split, clonotypes.split.unique, cluster.table))

}

```




make a spreadsheet with the TRA/Bs for patient 15
```{r}
require(tidyverse)
require(ggplot2)
p15.clonotypes = read.xlsx('patient15/p15_matches_tils_pbmcs-revised.xlsx')
colnames(p15.clonotypes)

results = MakeSpreadsheets(p15.clonotypes, p15.tils.cd8, 'patient15')
p15.til.clonotypes.split = results[[1]]
p15.til.clonotypes.split.unique = results[[2]]
p15.til.cluster.table = results[[3]]

GraphChains(p15.til.clonotypes.split, p1.til.cluster.table)

results = MakeSpreadsheets(p15.clonotypes, p15.pbmc.cd8, 'patient15')
p15.pbmc.clonotypes.split = results[[1]]
p15.pbmc.clonotypes.split.unique = results[[2]]
p15.pbmc.cluster.table = results[[3]]

GraphChains(p15.pbmc.clonotypes.split, p15.pbmc.cluster.table)
```


find markers for traced TCRs in big clusters
```{r}
# p15.tils.cd8@meta.data[is.na(p15.tils.cd8@meta.data$til.clonotype.family),]$til.clonotype.family <- 'None'
DimPlot(p15.tils.cd8, label=TRUE)
p15.tils.cd8$is.clone<-'No'
p15.tils.cd8$is.clone<-ifelse(is.na(p15.tils.cd8$TCR.Clone) | p15.tils.cd8$TCR.Clone==0, 'No', 'Yes')
p15.traced = p15.tils.cd8@meta.data %>% subset(TCR.Clone != 0 & !is.na(TCR.Clone))
DimPlot(p15.tils.cd8, cells.highlight = rownames(p15.traced))
Idents(p15.tils.cd8)<-p15.tils.cd8$clusters
for (i in 0:3) {
  cluster = subset(p15.tils.cd8, idents=i)
  Idents(cluster)<- p15.tils.cd8$is.clone
  family.markers = FindAllMarkers(cluster, min.pct = 0.25, assay='RNA')
  
  cat('number of genes before removing trabv:', nrow(family.markers), '\n')
  rownames(family.markers)
  trabs = grep('TRA|TRB', rownames(family.markers), value=TRUE)
  not_trabs = family.markers[setdiff(rownames(family.markers),trabs),]
  rownames(not_trabs)
  cat('number of genes after removing trabv:', nrow(not_trabs), '\n')
  topn = not_trabs %>% group_by(cluster) %>% top_n(n = 20, wt = avg_logFC)
  
  results = PrepHeatmap2(topn, cluster, topn)
  mat = results[[1]]
  annotations = results[[2]]
  karipalette = colorRampPalette(c('royalblue3','white', 'firebrick', 'firebrick4'))
  karipalette = colorRampPalette(c('white', 'firebrick'))
  show(pheatmap(mat, cluster_rows=TRUE, cluster_cols=FALSE, annotation_col = annotations, fontsize_row=8, fontsize_col = 1, color=karipalette(75)))

}

```


get markers for the top clonotype families
```{r}
highfreq = p15.clonotypes.split %>% subset(til.counts > 200); length(unique(highfreq$til.clonotype.family.x))
families = unique(highfreq$til.clonotype.family.x)
for (family in families) {
  ## for each clonotype family, find markers in that family vs all cells that were not traced
  majority.c = p15.clonotypes.split[p15.clonotypes.split$til.clonotype.family.x==family,]$clusters[1]; show(majority.c)
  cat('family:', family, '\nmajority.c:', majority.c, '\n')
  cells.family = p15.clonotypes.split[p15.clonotypes.split$til.clonotype.family.x==family & p15.clonotypes.split$majority.cluster==majority.c ,]$cell.barcode; length(cells.family)
  cells.rest = setdiff(rownames(p15.tils.cd8@meta.data)[p15.tils.cd8@meta.data$clusters==majority.c & p15.tils.cd8@meta.data$til.clonotype.family=='None'], cells.family); length(cells.rest)
  allcells = c(cells.family, cells.rest); length(allcells)
  cat('number of cells in p15:', ncol(p15.tils.cd8), '\n')
  Idents(p15.tils.cd8)<-p15.tils.cd8$clusters
  family.sub = subset(p15.tils.cd8, idents=majority.c); dim(family.sub)
  cat('number of cells in subset:', ncol(family.sub), '\n')
  Idents(family.sub)<-family.sub$til.clonotype.family
  family.sub = subset(family.sub, idents=c(family, 'None')); dim(family.sub)
  cat('number of cells in subset:', ncol(family.sub), '\n')
  
  # family.sub@meta.data[is.na(family.sub@meta.data$clusters),]<- majority.c
  
  Idents(family.sub)<-family.sub$til.clonotype.family
  family.markers = FindAllMarkers(family.sub, min.pct = 0.25, logfc.threshold = log(2), assay='RNA')
  cat('number of genes before removing trabv:', nrow(family.markers), '\n')
  rownames(family.markers)
  trabs = grep('TRA|TRB', rownames(family.markers), value=TRUE)
  not_trabs = family.markers[setdiff(rownames(family.markers),trabs),]
  rownames(not_trabs)
  cat('number of genes after removing trabv:', nrow(not_trabs), '\n')
  topn = not_trabs %>% group_by(cluster) %>% top_n(n = 20, wt = avg_logFC)
  
  results = PrepHeatmap(topn, family.sub, topn)
  mat = results[[1]]
  annotations = results[[2]]
  karipalette = colorRampPalette(c('royalblue3','white', 'firebrick', 'firebrick4'))
  karipalette = colorRampPalette(c('white', 'firebrick'))
  show(pheatmap(mat, cluster_rows=TRUE, cluster_cols=FALSE, annotation_col = annotations, fontsize_row=8, fontsize_col = 1, color=karipalette(75)))
}

```




make a spreadsheet with the TRA/Bs for patient 2
```{r}
#   tras.small = tras.small %>% subset(TRAV_1.1!=0) %>% distinct(by=c(til.clonotype.family), .keep_all=TRUE); dim(tras.small); length(unique(tras.small$til.clonotype.family))

require(tidyverse)
require(ggplot2)
p2.clonotypes = read.xlsx('patient2/matches_tils_pbmcs_7_revised.xlsx')
colnames(p2.clonotypes)

results = MakeSpreadsheets(p2.clonotypes, p2.tils.cd8, 'patient2')
p2.til.clonotypes.split = results[[1]]
p2.til.clonotypes.split.unique = results[[2]]
p2.til.cluster.table = results[[3]]

GraphChains(p2.til.clonotypes.split, p2.til.cluster.table)

p2.clonotypes.use = p2.clonotypes[,colnames(p2.clonotypes)=='til.clonotype.family'] <- NULL
results = MakeSpreadsheets(p2.clonotypes, p2.pbmc.cd8.2, 'patient2')
p2.pbmc.clonotypes.split = results[[1]]
p2.pbmc.clonotypes.split.unique = results[[2]]
p2.pbmc.cluster.table = results[[3]]

GraphChains(p2.pbmc.clonotypes.split, p2.pbmc.cluster.table)
```


get markers for the top clonotypes
```{r}
p2.tils.cd8@meta.data[is.na(p2.tils.cd8@meta.data$til.clonotype.family),]$til.clonotype.family <- 'None'
DimPlot(p2.tils.cd8, label=TRUE)

highfreq = p2.clonotypes.split %>% subset(til.counts > 70); length(unique(highfreq$til.clonotype.family.x))
families = unique(highfreq$til.clonotype.family.x)
for (family in families) {
  ## for each clonotype family, find markers in that family vs all cells that were not traced
  majority.c = p2.clonotypes.split[p2.clonotypes.split$til.clonotype.family.x==family,]$clusters[1]; show(majority.c)
  cat('family:', family, '\nmajority.c:', majority.c, '\n')
  cat('number of cells in p15:', ncol(p2.tils.cd8), '\n')
  Idents(p2.tils.cd8)<-p2.tils.cd8$clusters
  family.sub = subset(p2.tils.cd8, idents=majority.c); dim(family.sub)
  cat('number of cells in subset:', ncol(family.sub), '\n')
  Idents(family.sub)<-family.sub$til.clonotype.family
  family.sub = subset(family.sub, idents=c(family, 'None')); dim(family.sub)
  cat('number of cells in subset:', ncol(family.sub), '\n')
  
  # family.sub@meta.data[is.na(family.sub@meta.data$clusters),]<- majority.c
  
  Idents(family.sub)<-family.sub$til.clonotype.family
  family.markers = FindAllMarkers(family.sub, min.pct = 0.25, logfc.threshold = log(2), assay='RNA')
  cat('number of genes before removing trabv:', nrow(family.markers), '\n')
  rownames(family.markers)
  trabs = grep('TRA|TRB', rownames(family.markers), value=TRUE)
  not_trabs = family.markers[setdiff(rownames(family.markers),trabs),]
  rownames(not_trabs)
  cat('number of genes after removing trabv:', nrow(not_trabs), '\n')
  topn = not_trabs %>% group_by(cluster) %>% top_n(n = 20, wt = avg_logFC)
  
  results = PrepHeatmap(topn, family.sub, topn)
  mat = results[[1]]
  annotations = results[[2]]
  karipalette = colorRampPalette(c('royalblue3','white', 'firebrick', 'firebrick4'))
  karipalette = colorRampPalette(c('white', 'firebrick'))
  show(pheatmap(mat, cluster_rows=TRUE, cluster_cols=FALSE, annotation_col = annotations, fontsize_row=8, fontsize_col = 1, color=karipalette(75)))
}

```



